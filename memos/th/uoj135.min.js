window.onload=function(){if(!window.BigInt)return alert("很抱歉，您的浏览器不支持 BigInt，请升级浏览器后再进入此页面 :)");if(!Element.prototype.animate)return alert("很抱歉，您的浏览器不支持 Element.animate，请升级浏览器后再进入此页面 :)");const t=document.getElementById.bind(document),e=t("cvs"),s=e.namespaceURI,i=t("controller-status"),n=t("stage-status"),r=t("stage-main"),a=parseInt,l=parseFloat,o=t=>BigInt(t),u=t("delta-score").animate([{transform:"translateY(25px)",opacity:0},{opacity:1},{transform:"translateY(-25px)",opacity:0}],{duration:250,fill:"forwards",easing:"cubic-bezier(0,0.75,1,0.25)"}),c=window.performance&&window.performance.now?()=>window.performance.now():()=>Date.now(),d=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||(t=>setTimeout(t,83.333,c()));let h,p,f,m,b,g,y,x,w,$,M,v,S,k,A,L,T,C=-1,q=!1;function H(t){i.innerHTML=t}function E(t){n.innerHTML=t}function F(t,e,s){return Math.min(Math.max(t,e),s)}function R(){let t=e.parentNode.parentNode.clientWidth-10,s=Math.max(Math.min(window.innerHeight,document.documentElement.clientHeight)-200,300),i=F(Math.max(h/t,p/s),.001,1e3);return i>=1?i.toFixed(3):i.toPrecision(4)}function z(t,e,s,i,n){return e<=t&&t<=s||(H(`<span class="text-danger">第 ${i} 行：参数 ${n} 等于 ${t}，不在范围 [${e}, ${s}] 中</span>`),!1)}function N(t){let e,s,i=t.length,n=0,r=0,a=0;for(e=0,s=1-i;e<i;++e,s+=2)n+=t[e],r+=s*t[e],a+=t[e]*t[e];return 3*r*r/((i*i-1)*(i*a-n*n))}async function I(e){H("读取文件中 ...");let s=(await e.text()).split("\n").map(t=>t.trimEnd()).filter(t=>t);if(!s.length)return H('<span class="text-danger">空地图文件</span>');let i,n=s[0].split(" "),r=!0;if(H("解析文件中 (0%) ..."),7!==n.length)return H('<span class="text-danger">第 1 行：格式错误</span>');if((r=(r=(r=(r=(r=(r=(r=r&&z(h=a(n[0]),1,2048,1,"w"))&&z(p=a(n[1]),1,2048,1,"h"))&&z(f=l(n[2]),0,h,1,"x<sub>0</sub>"))&&z(m=l(n[3]),0,p,1,"y<sub>0</sub>"))&&z(b=l(n[4]),0,2048,1,"d"))&&z(g=l(n[5]),0,2048,1,"r"))&&z(y=l(n[6]),g,2048,1,"R"))&&(H("解析文件中 (10%) ..."),z(x=a(s[1]),0,32767,2,"n"))){for(H("解析文件中 (20%) ..."),v=[],i=0;i<x;++i){0==(255&i)&&H(`解析文件中 (${(39*i/x+20).toFixed(0)}%) ...`);let t=s[2+i]?s[2+i].split(" "):[];if(8!==t.length)return H(`<span class="text-danger">第 ${3+i} 行：格式错误</span>`);if(!(r=(r=(r=(r=(r=(r=(r=(r=r&&z(t[0]=a(t[0]),0,32767,3+i,`a<sub>${1+i}</sub>`))&&z(t[1]=a(t[1]),t[0],32767,3+i,`b<sub>${1+i}</sub>`))&&z(t[2]=l(t[2]),0,h,3+i,`x<sub>${1+i}</sub>`))&&z(t[3]=l(t[3]),0,p,3+i,`y<sub>${1+i}</sub>`))&&z(t[4]=l(t[4]),-32767,32767,3+i,`vx<sub>${1+i}</sub>`))&&z(t[5]=l(t[5]),-32767,32767,3+i,`vy<sub>${1+i}</sub>`))&&z(t[6]=l(t[6]),0,2048,3+i,`r<sub>${1+i}</sub>`))&&z(t[7]=o(t[7]),0,1/0,3+i,`g<sub>${1+i}</sub>`)))return;v.push(t)}if(v.sort((t,e)=>t[7]===e[7]?t[6]-e[6]:Number(t[7]-e[7])),x>0)switch(A=Number(v[0][7]),L=Number(v[x-1][7]),T=function(t){if(t[0]<=0||t[0]===t[x-1])return 1;let e,s,i=N(t);for(s=0;s<t.length;++s)t[s]=Math.log(t[s]);return e=N(t),console.log("linear =>",i," logarithm =>",e),i>=e?1:2}(v.map(t=>Number(t[7])))){case 1:break;case 2:A=Math.log(A),L=Math.log(L)}else T=1;if(H("解析文件中 (59%) ..."),z(w=a(s[2+x]),0,32767,3+x,"m")){for(H("解析文件中 (60%) ..."),k=[],i=0;i<w;++i){0==(255&i)&&H(`解析文件中 (${(39*i/x+60).toFixed(0)}%) ...`);let t=s[3+x+i]?s[3+x+i].split(" "):[];if(3!==t.length)return H(`<span class="text-danger">第 ${4+x+i} 行：格式错误</span>`);if(!(r=(r=(r=r&&z(t[0]=a(t[0]),0,32767,4+x+i,`s<sub>${1+i}</sub>`))&&z(t[1]=a(t[1]),0,32767,4+x+i,`e<sub>${1+i}</sub>`))&&z(t[2]=o(t[2]),0,1/0,4+x+i,`S<sub>${1+i}</sub>`)))return;k.push(t)}k.sort((t,e)=>t[1]===e[1]?Number(t[2]-e[2]):e[1]-t[1]),H("解析文件中 (99%) ..."),z($=a(s[3+x+w]),0,32767,4+x+w,"T")&&(H('<span class="text-success">文件加载完毕</span>'),t("total-time").innerHTML=$.toString().padStart(5,"0"),t("scale").value=R().toString(),t("tscale").value=F(.05*$,1,60).toFixed(3).toString(),q=!0)}}}t("file-input").addEventListener("input",(function(){let e=t("file-input").files;q=!1,e.length?I(e[0]):H("请选择文件")}));let O,_,B,D,P,X,Y,G,U,Q,Z,j,W,J,K,V,tt,et,st,it,nt={ks:null,mem0:null,mem1:null,allow_keys:[87,88,65,68,81,90,69,67],reset(){this.ks=new Set,this.mem0=this.mem1=0},insert(t){this.ks instanceof Set&&this.allow_keys.includes(t)&&(this.ks.add(t),this.mem0=t)},erase(t){this.ks instanceof Set&&this.allow_keys.includes(t)&&(this.ks.delete(t),this.mem0===t&&(this.mem1=t))},query(){let t=this.mem1;if(this.mem0=this.mem1=0,this.ks.has(87)&&this.ks.has(65))return"Q";if(this.ks.has(88)&&this.ks.has(65))return"Z";if(this.ks.has(87)&&this.ks.has(68))return"E";if(this.ks.has(88)&&this.ks.has(68))return"C";for(let t of this.allow_keys)if(this.ks.has(t))return String.fromCharCode(t);return t?String.fromCharCode(t):"S"}},rt={queue:null,allow_keys:[87,88,65,68,81,90,69,67],reset(){this.queue=[]},push_back(t){this.queue instanceof Array&&this.allow_keys.includes(t)&&this.queue.push(t)},query(){return this.queue.length?String.fromCharCode(this.queue.shift()):"S"}},at={x:null,y:null,reset(){this.x=this.y=null},set(t,e){this.x=t,this.y=e},query(t,e){t-=this.x*_,e-=this.y*_;let s,i="S",n=Math.hypot(t,e);for(let r in O)(s=Math.hypot(t+O[r][0],e+O[r][1]))<n&&(i=r,n=s);return i}},lt=t=>t,ot=!1;function ut(t,e,i,n,r,a,l,o,u){if(this.ta=e,this.tb=i,this.x=n,this.y=r,this.vx=a,this.vy=l,this.r=o,this.g=u,!Z.has(u)){Z.add(u);let t=document.createElementNS(s,"radialGradient"),[e,i,n]=function(t){let e,s,i,n=NaN;switch(t=Number(t),T){case 1:n=(t-A)/(L-A);break;case 2:n=(Math.log(t)-A)/(L-A)}return(n=n==n?F(n,0,1):2/3)>=2/3?(e=i=255,s=Math.round(255*n-170)):(e=i=Math.round(255*n+85),s=0),[`rgb(${e+256>>1}, ${s+256>>1}, ${i+256>>1})`,`rgb(${e}, ${s}, ${i})`,`rgba(${e}, ${s}, ${i}, 0)`]}(u);t.id=`GR${u}`,t.innerHTML=`<stop offset="0%" style="stop-color: white" /><stop offset="50%" style="stop-color: ${e}" /><stop offset="79%" style="stop-color: ${i}" /><stop offset="100%" style="stop-color: ${n}" />`,Q.appendChild(t)}let c=document.createElementNS(s,"circle");if(c.setAttribute("cx",n*D),c.setAttribute("cy",r*D),c.setAttribute("r",Math.max(o*D,2)),c.style.fill=`url(#GR${u})`,a||l){let t=(i-e)*D;(this.movement=c.animate([{transform:"translate(0px, 0px)"},{transform:`translate(${a*t}px, ${l*t}px)`}],{duration:(i-e)*P*1e3,fill:"forwards"})).finish()}this.circle=c}document.addEventListener("keydown",(function(t){if(!~C)return;let e=t.which||t.keyCode;(e=lt(37<=e&&e<=40?(t.preventDefault(),[65,87,68,88][e-37]):e))&&!t.repeat&&nt.insert(e),rt.push_back(e),16===e&&(ot=!0)})),document.addEventListener("keyup",(function(e){if(!~C)return;let s=e.which||e.keyCode;(s=lt(37<=s&&s<=40?(e.preventDefault(),[65,87,68,88][s-37]):s))&&!e.repeat&&nt.erase(s),16===s&&(ot=!1),17===s&&(t("player-graze-circle").style.visibility=t("player-graze-circle").style.visibility?"":"hidden")})),e.addEventListener("mousemove",(function(t){let e;t.offsetX&&t.offsetY||(e=t.target.getBoundingClientRect(),t.offsetX=t.offsetX||t.clientX-e.left,t.offsetY=t.offsetY||t.clientY-e.top),at.set(t.offsetX,t.offsetY)})),ut.prototype={alive(t){return this.ta<=t&&t<=this.tb},position(t){return[this.x+(t-this.ta)*this.vx,this.y+(t-this.ta)*this.vy]}};let ct={last:0,data:0,sum:0,fps:0,reset(){this.last=null,this.data=[],this.sum=0,this.fps=null},update(t){null!==this.last&&(this.sum+=t-this.last,this.data.push(t-this.last),this.data.length>60&&(this.sum-=this.data.shift()),this.fps=1e3*this.data.length/this.sum),this.last=t},info(){return null===this.fps?"很抱歉，您的浏览器不支持 requestAnimationFrame，无法获得帧率":`平均帧率：${this.fps.toFixed(2)} Hz`}};function dt(e){e&&ct.update(e);let s,i,n,a,l,o,f=c()-K,m=Math.min(Math.floor(f*B*.001),$+1),b=BigInt(0);if(console.assert(C<=m+1,"Strange things happen"),m>$){if(W.hasOwnProperty(m))for(i of W[m])r.removeChild(M[i].circle);return setTimeout(ft,1e3)}for(;C<=m;++C){if(!V&&C&&"S"===tt[C-1]&&(tt[C-1]=ot?at.query(G,U):et()),C&&"S"!==tt[C-1]&&([n,a]=O[tt[C-1]],a+=U,-1e-9<=(n+=G)&&n<=h+1e-9&&-1e-9<=a&&a<=p+1e-9?(G=n,U=a,t("player-body-circle").setAttribute("cx",G*D),t("player-body-circle").setAttribute("cy",U*D),t("player-graze-circle").setAttribute("cx",G*D),t("player-graze-circle").setAttribute("cy",U*D),t("cur-coordinate-x").innerHTML=Math.abs(G).toFixed(2),t("cur-coordinate-y").innerHTML=Math.abs(U).toFixed(2)):tt[C-1]="S"),s=(f=c()-K)-C*P*1e3,j.hasOwnProperty(C)){let t=document.createDocumentFragment();for(i of j[C])t.appendChild(M[i].circle);for(i of(r.appendChild(t),j[C]))M[i].hasOwnProperty("movement")&&(M[i].movement.currentTime=s)}for(o=!1,i=0;i<x;++i)M[i].alive(C)&&([n,a]=M[i].position(C),(l=Math.hypot(G-n,U-a))<=y+M[i].r+1e-9?(J[i]||(M[i].circle.style.fill="url(#GRZD)",st+=M[i].g,J[i]=!0),M[i].circle.classList.add("bullet-close")):M[i].circle.classList.remove("bullet-close"),o=o||l<=g+M[i].r+1e-9);for(o?(it=C,t("player").classList.add("danger")):t("player").classList.remove("danger");S.length;)if(it>=S[S.length-1][0])S.pop();else{if(!(C>=S[S.length-1][1]))break;b+=S[S.length-1][2],S.pop()}if(W.hasOwnProperty(C))for(i of W[C])r.removeChild(M[i].circle)}b&&(st+=b,t("delta-score").innerHTML=`+ ${b}`,u.play()),t("cur-time").innerHTML=m.toString().padStart(5,"0"),t("cur-score").innerHTML=st.toString(),S.length?(t("next-bonus-time").innerHTML=(S[S.length-1][1]-m).toString(),t("next-bonus-amount").innerHTML=S[S.length-1][2].toString()):(t("next-bonus-time").innerHTML="N/A",t("next-bonus-amount").innerHTML="N/A"),E(ct.info()),d(dt)}async function ht(s){let i=b*Math.SQRT1_2;if(!q)return H('<span class="text-danger">配置未成功，请选择文件！');if(_=l(t("scale").value),D=1/_,!(.001<=_&&_<=1e3))return H(`<span class="text-danger">尺寸比例尺 1 : ${_} 不在范围 [10<sup>-3</sup>, 10<sup>3</sup>] 中</span>`);if(B=l(t("tscale").value),P=1/B,!(1<=B&&B<=60))return H(`<span class="text-danger">时间比例尺 1 : ${B} 不在范围 [1, 60] 中</span>`);if(X=Math.max(Math.round(h*D),1),Y=Math.max(Math.round(p*D),1),X<10&&Y<10&&!confirm("过小的比例尺会降低视觉体验，确定继续？"))return t("scale").value=R().toString();if(X>16384||Y>8192)return t("scale").value=R().toString(),H(`<span class="text-danger">尺寸比例尺 1 : ${_} 过大，不适于在屏幕中显示，请调整。`);if(X>2e3&&Y>1500&&!confirm("过大的比例尺会降低视觉体验，确定继续？"))return t("scale").value=R().toString();if(V=s){if(!(tt=await async function(){let e,s,i,n,r=t("file-output").files;if(!r.length)return H('<span class="text-danger">未选择决策文件</span>');if((s=(e=await r[0].text()).split("\n")).length>2||2===s.length&&s[1])return H('<span class="text-danger">决策文件过长</span>');if((e=s[0].trimEnd()).length!==$)return H(`<span class="text-danger">决策文件第 1 行：期望长度为 ${$} 的字符串，但读取到长度为 ${e.length} 的字符串</span>`);for(i=0;i<$;++i)if(!"WXADQZECS".includes(e[i]))return H(`<span class="text-danger">决策文件第 1 行：第 ${i+1} 个字符 <samp>"${n=32<=(n=e.charCodeAt(i))&&n<=126?e[i]:0<=n&&n<=255?`<strong>\\x${n.toString(16).padStart(2,"0")}</strong>`:`<strong>\\u${n.toString(16).padStart(4,"0")}</strong>`}"</samp> 不合法</span>`);return e}()))return}else tt="S".repeat($);tt=tt.split(""),e.setAttribute("width",X+"px"),e.setAttribute("height",Y+"px"),H('<span class="text-success">配置成功，准备进入游戏 ...</span>'),E("准备中 ..."),window.scrollTo({top:t("stage-title").parentNode.offsetTop-10,behavior:"smooth"}),t("file-input").disabled=!0,t("file-output").disabled=!0,t("scale").disabled=!0,t("tscale").disabled=!0,t("queue-op").disabled=!0,t("sx-swap").disabled=!0,t("download-op").disabled=!0,t("start-manual").disabled=!0,t("start-auto").disabled=!0,t("stage-text-elem").setAttribute("x",X/2),t("stage-text-elem").setAttribute("y",Y/2),t("stage-text-elem").style.fontSize="36px",t("stage-text-elem").textContent="Preparing ...",t("stage-text-elem").style.visibility="",t("player-body-circle").setAttribute("cx",f*D),t("player-body-circle").setAttribute("cy",m*D),t("player-body-circle").setAttribute("r",Math.max(g*D,2)),t("player-graze-circle").setAttribute("cx",f*D),t("player-graze-circle").setAttribute("cy",m*D),t("player-graze-circle").setAttribute("r",Math.max(y*D,2)),t("cur-coordinate-x").innerHTML=f.toFixed(2),t("cur-coordinate-y").innerHTML=m.toFixed(2),lt=t("sx-swap").checked?t=>83===t||88===t?11^t:t:t=>t,O={W:[0,-b],X:[0,b],A:[-b,0],D:[b,0],Q:[-i,-i],Z:[-i,i],E:[i,-i],C:[i,i]},et=t("queue-op").checked?()=>rt.query():()=>nt.query(),S=[...k],setTimeout(()=>{const e=e=>{t("stage-text-elem").style.fontSize="100px",t("stage-text-elem").textContent=e},s=(t,e,s)=>{t.hasOwnProperty(e)||(t[e]=[]),t[e].push(s)};t("stage-bullet-definitions").innerHTML="",r.innerHTML="",Q=document.createDocumentFragment(),Z=new Set,j={},W={},M=[];for(let t=0;t<x;++t)M[t]=new ut(t,...v[t]),s(j,M[t].ta,t),s(W,M[t].tb+1,t);t("stage-bullet-definitions").appendChild(Q),setTimeout(e,50,"3"),setTimeout(e,1050,"2"),setTimeout(e,2050,"1"),setTimeout(pt,3050)},50)}function pt(){t("stage-text-elem").style.visibility="hidden",H('<span class="text-success">游戏进行中 ...</span>'),nt.reset(),rt.reset(),ct.reset(),K=c(),st=BigInt(0),C=0,G=f,U=m,it=-1,J=new Array(x).fill(!1),d(dt)}function ft(){for(let t=0;t<x;++t)M[t].circle.style.fill=`url(#GR${M[t].g})`,M[t].circle.classList.remove("bullet-close");H('<span class="text-info">游戏已结束，您可以点击上方的蓝色按钮导出决策文件</span>'),E("已结束"),C=-1,t("player-body-circle").setAttribute("cx",1e18),t("player-body-circle").setAttribute("cy",1e18),t("player-graze-circle").setAttribute("cx",1e18),t("player-graze-circle").setAttribute("cy",1e18),t("stage-text-elem").style.fontSize="24px",t("stage-text-elem").textContent=`最终成绩：${st}`,t("stage-text-elem").style.visibility="",t("file-input").disabled=!1,t("file-output").disabled=!1,t("scale").disabled=!1,t("tscale").disabled=!1,t("queue-op").disabled=!1,t("sx-swap").disabled=!1,t("download-op").disabled=!1,t("start-manual").disabled=!1,t("start-auto").disabled=!1}t("start-manual").addEventListener("click",(function(){ht(!1)})),t("start-auto").addEventListener("click",(function(){ht(!0)})),t("download-op").addEventListener("click",(function(){if(Array.isArray(tt)&&tt.length===$){let e,s=t("file-input").value;e=(s=s.substr(Math.max(s.lastIndexOf("/"),s.lastIndexOf("\\"))+1)).lastIndexOf("."),s=~e?s.substr(0,e):s,(e=document.createElement("a")).href=URL.createObjectURL(new Blob([tt.join("")+"\n"],{type:"text/plain"})),e.download=`${s}.out`,e.click(),URL.revokeObjectURL(e.href)}else alert("尚未找到决策，请先开始游戏")}))};