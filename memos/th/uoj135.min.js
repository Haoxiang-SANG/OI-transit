window.onload=function(){if(!window.BigInt)return void alert("很抱歉，您的浏览器不支持 BigInt，请升级浏览器后再进入此页面 :)");const t=document.getElementById.bind(document),e=t("cvs"),s=e.namespaceURI,n=t("controller-status"),r=t("stage-status"),a=t("stage-main"),l=parseInt,o=parseFloat,u=t=>BigInt(t),c=t("delta-score").animate([{transform:"translateY(25px)",opacity:0},{opacity:1},{transform:"translateY(-25px)",opacity:0}],{duration:250,fill:"forwards",easing:"cubic-bezier(0, 0.75, 1, 0.25)"}),d=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||(t=>setTimeout(t,83.333)),h=performance.now?()=>performance.now():()=>Date.now();let p,f,m,b,g,y,x,w,$,M,v,A,S,L,k,T,C,q,H=!1;function E(t){n.innerHTML=t}function F(t){r.innerHTML=t}function N(t,e,s){return Math.min(Math.max(t,e),s)}function z(){let t=e.parentNode.parentNode.clientWidth-10,s=Math.max(Math.min(window.innerHeight,document.documentElement.clientHeight)-200,300),i=N(Math.max(p/t,f/s),.001,1e3);return i>=1?i.toFixed(3):i.toPrecision(4)}function R(t,e,s,i,n){return e<=t&&t<=s||(E(`<span class="text-danger">第 ${i} 行：参数 ${n} 等于 ${t}，不在范围 [${e}, ${s}] 中</span>`),!1)}function I(t){let e,s,i=t.length,n=0,r=0,a=0;for(e=0,s=1-i;e<i;++e,s+=2)n+=t[e],r+=s*t[e],a+=t[e]*t[e];return 3*r*r/((i*i-1)*(i*a-n*n))}async function O(e){E("读取文件中 ...");let s=(await e.text()).split("\n").map(t=>t.trimEnd()).filter(t=>t);if(!s.length)return E('<span class="text-danger">空地图文件</span>');let i,n=s[0].split(" "),r=!0;if(E("解析文件中 (0%) ..."),7!==n.length)return E('<span class="text-danger">第 1 行：格式错误</span>');if((r=(r=(r=(r=(r=(r=(r=r&&R(p=l(n[0]),1,2048,1,"w"))&&R(f=l(n[1]),1,2048,1,"h"))&&R(m=o(n[2]),0,p,1,"x<sub>0</sub>"))&&R(b=o(n[3]),0,f,1,"y<sub>0</sub>"))&&R(g=o(n[4]),0,2048,1,"d"))&&R(y=o(n[5]),0,2048,1,"r"))&&R(x=o(n[6]),y,2048,1,"R"))&&(E("解析文件中 (10%) ..."),R(w=l(s[1]),0,32767,2,"n"))){for(E("解析文件中 (20%) ..."),S=[],i=0;i<w;++i){0==(255&i)&&E(`解析文件中 (${(39*i/w+20).toFixed(0)}%) ...`);let t=s[2+i]?s[2+i].split(" "):[];if(8!==t.length)return E(`<span class="text-danger">第 ${3+i} 行：格式错误</span>`);if(!(r=(r=(r=(r=(r=(r=(r=(r=r&&R(t[0]=l(t[0]),0,32767,3+i,`a<sub>${1+i}</sub>`))&&R(t[1]=l(t[1]),t[0],32767,3+i,`b<sub>${1+i}</sub>`))&&R(t[2]=o(t[2]),0,p,3+i,`x<sub>${1+i}</sub>`))&&R(t[3]=o(t[3]),0,f,3+i,`y<sub>${1+i}</sub>`))&&R(t[4]=o(t[4]),-32767,32767,3+i,`vx<sub>${1+i}</sub>`))&&R(t[5]=o(t[5]),-32767,32767,3+i,`vy<sub>${1+i}</sub>`))&&R(t[6]=o(t[6]),0,2048,3+i,`r<sub>${1+i}</sub>`))&&R(t[7]=u(t[7]),0,1/0,3+i,`g<sub>${1+i}</sub>`)))return;S.push(t)}switch(S.sort((t,e)=>t[7]===e[7]?t[6]-e[6]:Number(t[7]-e[7])),T=Number(S[0][7]),C=Number(S[w-1][7]),q=function(t){if(t[0]<=0||t[0]===t[w-1])return 1;let e,s,i=I(t);for(s=0;s<t.length;++s)t[s]=Math.log(t[s]);return e=I(t),console.log("linear =>",i," logarithm =>",e),i>=e?1:2}(S.map(t=>Number(t[7])))){case 1:break;case 2:T=Math.log(T),C=Math.log(C)}if(E("解析文件中 (59%) ..."),R($=l(s[2+w]),0,32767,3+w,"m")){for(E("解析文件中 (60%) ..."),k=[],i=0;i<$;++i){0==(255&i)&&E(`解析文件中 (${(39*i/w+60).toFixed(0)}%) ...`);let t=s[3+w+i]?s[3+w+i].split(" "):[];if(3!==t.length)return E(`<span class="text-danger">第 ${4+w+i} 行：格式错误</span>`);if(!(r=(r=(r=r&&R(t[0]=l(t[0]),0,32767,4+w+i,`s<sub>${1+i}</sub>`))&&R(t[1]=l(t[1]),0,32767,4+w+i,`e<sub>${1+i}</sub>`))&&R(t[2]=u(t[2]),0,1/0,4+w+i,`S<sub>${1+i}</sub>`)))return;k.push(t)}k.sort((t,e)=>t[1]===e[1]?Number(t[2]-e[2]):e[1]-t[1]),E("解析文件中 (99%) ..."),R(v=l(s[3+w+$]),0,32767,4+w+$,"T")&&(E('<span class="text-success">文件加载完毕</span>'),t("total-time").innerHTML=v.toString().padStart(5,"0"),t("scale").value=z().toString(),t("tscale").value=N(.05*v,1,60).toFixed(3).toString(),H=!0)}}}t("file-input").addEventListener("input",(function(){let e=t("file-input").files;H=!1,e.length?O(e[0]):E("请选择文件")}));let B,P,_,X,Y,D,G,U,j,Q,W,Z,J,K,V,tt,et,st,it,nt,rt={ks:null,mem0:null,mem1:null,allow_keys:[87,88,65,68,81,90,69,67],reset(){this.ks=new Set,this.mem0=this.mem1=0},insert(t){this.ks instanceof Set&&(this.ks.add(t),this.mem0=t)},erase(t){this.ks instanceof Set&&(this.ks.delete(t),this.mem0===t&&(this.mem1=t))},query(){let t=this.mem1;this.mem0=this.mem1=0;for(let t of this.allow_keys)if(this.ks.has(t))return String.fromCharCode(t);return this.allow_keys.includes(t)?String.fromCharCode(t):"S"}},at={queue:null,allow_keys:[87,88,65,68,81,90,69,67],reset(){this.queue=[]},push_back(t){this.queue instanceof Array&&this.allow_keys.includes(t)&&this.queue.push(t)},query(){return this.queue.length?String.fromCharCode(this.queue.shift()):"S"}},lt={x:null,y:null,reset(){this.x=this.y=null},set(t,e){this.x=t,this.y=e},query(t,e){t-=this.x*P,e-=this.y*P;let s,i="S",n=Math.hypot(t,e);for(let r in B)(s=Math.hypot(t+B[r][0],e+B[r][1]))<n&&(i=r,n=s);return i}},ot=t=>t,ut=!1;function ct(t,e,i,n,r,a,l,o,u){if(this.ta=e,this.tb=i,this.x=n,this.y=r,this.vx=a,this.vy=l,this.r=o,this.g=u,!W.has(u)){W.add(u);let t=document.createElementNS(s,"radialGradient"),[e,i,n]=function(t){let e,s,i,n=NaN;switch(t=Number(t),q){case 1:n=(t-T)/(C-T);break;case 2:n=(Math.log(t)-T)/(C-T)}return(n=n==n?N(n,0,1):2/3)>=2/3?(e=i=255,s=Math.round(255*n-170)):(e=i=Math.round(255*n+85),s=0),[`rgb(${e+256>>1}, ${s+256>>1}, ${i+256>>1})`,`rgb(${e}, ${s}, ${i})`,`rgba(${e}, ${s}, ${i}, 0)`]}(u);t.id=`GR${u}`,t.innerHTML=`<stop offset="0%" style="stop-color: white" /><stop offset="50%" style="stop-color: ${e}" /><stop offset="79%" style="stop-color: ${i}" /><stop offset="100%" style="stop-color: ${n}" />`,Q.appendChild(t)}let c=document.createElementNS(s,"circle");if(c.setAttribute("cx",n*X),c.setAttribute("cy",r*X),c.setAttribute("r",Math.max(o*X,2)),c.style.fill=`url(#GR${u})`,a||l){let t=document.createElementNS(s,"animateMotion"),n=(i-e)*X;t.setAttribute("begin","indefinite"),t.setAttribute("path",`M0,0L${a*n},${l*n}`),t.setAttribute("dur",(i-e)*Y+"s"),t.setAttribute("fill","freeze"),c.appendChild(t),this.movement=t}this.circle=c}document.addEventListener("keydown",(function(t){let e=ot(t.which||t.keyCode);!t.repeat&&e&&rt.insert(e),at.push_back(e),16===e&&(ut=!0)})),document.addEventListener("keyup",(function(e){let s=ot(e.which||e.keyCode);!e.repeat&&s&&rt.erase(s),16===s&&(ut=!1),17===s&&(t("player-graze-circle").style.visibility=t("player-graze-circle").style.visibility?"":"hidden")})),e.addEventListener("mousemove",(function(t){let e;t.offsetX&&t.offsetY||(e=t.target.getBoundingClientRect(),t.offsetX=t.offsetX||t.clientX-e.left,t.offsetY=t.offsetY||t.clientY-e.top),lt.set(t.offsetX,t.offsetY)})),ct.prototype={alive(t){return this.ta<=t&&t<=this.tb},position(t){return[this.x+(t-this.ta)*this.vx,this.y+(t-this.ta)*this.vy]}};let dt={last:0,data:0,sum:0,fps:0,reset(){this.last=null,this.data=[],this.sum=0,this.fps=null},update(t){null!==this.last&&(this.sum+=t-this.last,this.data.push(t-this.last),this.data.length>60&&(this.sum-=this.data.shift()),this.fps=1e3*this.data.length/this.sum),this.last=t},info(){return null===this.fps?"很抱歉，您的浏览器不支持 requestAnimationFrame，无法获得帧率":`平均帧率：${this.fps.toFixed(2)} Hz`}};function ht(e){e&&dt.update(e);let s,n,r,l,o=h()-V,u=Math.min(Math.floor(o*_*.001),v),m=BigInt(0);for(console.assert(M<=u+1,"Strange things happen");M<=u;++M){if(!tt&&M&&"S"===et[M-1]&&(et[M-1]=ut?lt.query(U,j):st()),M&&"S"!==et[M-1]&&([n,r]=B[et[M-1]],r+=j,-1e-9<=(n+=U)&&n<=p+1e-9&&-1e-9<=r&&r<=f+1e-9?(U=n,j=r,t("player-body-circle").setAttribute("cx",U*X),t("player-body-circle").setAttribute("cy",j*X),t("player-graze-circle").setAttribute("cx",U*X),t("player-graze-circle").setAttribute("cy",j*X),t("cur-coordinate-x").innerHTML=Math.abs(U).toFixed(2),t("cur-coordinate-y").innerHTML=Math.abs(j).toFixed(2)):et[M-1]="S"),o=h()-V,Z.hasOwnProperty(M)){let t=document.createDocumentFragment();for(let e of Z[M])t.appendChild(A[e].circle);a.appendChild(t),s=M*Y-.001*o;for(let t of Z[M])A[t].hasOwnProperty("movement")&&A[t].movement.beginElementAt(s)}for(l=!1,i=0;i<w;++i)A[i].alive(M)&&([n,r]=A[i].position(M),(s=Math.hypot(U-n,j-r))<=x+A[i].r+1e-9?(K[i]||(A[i].circle.style.fill="url(#GRZD)",it+=A[i].g,K[i]=!0),A[i].circle.classList.add("bullet-close")):A[i].circle.classList.remove("bullet-close"),l=l||s<=y+A[i].r+1e-9);for(l?(nt=M,t("player").classList.add("danger")):t("player").classList.remove("danger");L.length;)if(nt>=L[L.length-1][0])L.pop();else{if(!(M>=L[L.length-1][1]))break;m+=L[L.length-1][2],L.pop()}if(J.hasOwnProperty(M))for(let t of J[M])a.removeChild(A[t].circle)}m&&(it+=m,t("delta-score").innerHTML=`+ ${m}`,c.play()),t("cur-time").innerHTML=u.toString().padStart(5,"0"),t("cur-score").innerHTML=it.toString(),L.length?(t("next-bonus-time").innerHTML=(L[L.length-1][1]-u).toString(),t("next-bonus-amount").innerHTML=L[L.length-1][2].toString()):(t("next-bonus-time").innerHTML="N/A",t("next-bonus-amount").innerHTML="N/A"),F(dt.info()),M<=v?d(ht):setTimeout(mt,1500)}async function pt(s){let i=g*Math.SQRT1_2;if(!H)return E('<span class="text-danger">配置未成功，请选择文件！');if(P=o(t("scale").value),X=1/P,!(.001<=P&&P<=1e3))return E(`<span class="text-danger">尺寸比例尺 1 : ${P} 不在范围 [10<sup>-3</sup>, 10<sup>3</sup>] 中</span>`);if(_=o(t("tscale").value),Y=1/_,!(1<=_&&_<=60))return E(`<span class="text-danger">时间比例尺 1 : ${_} 不在范围 [1, 60] 中</span>`);if(D=Math.max(Math.round(p*X),1),G=Math.max(Math.round(f*X),1),D<10&&G<10&&!confirm("过小的比例尺会降低视觉体验，确定继续？"))return t("scale").value=z().toString();if(D>16384||G>8192)return t("scale").value=z().toString(),E(`<span class="text-danger">尺寸比例尺 1 : ${P} 过大，不适于在屏幕中显示，请调整。`);if(D>2e3&&G>1500&&!confirm("过大的比例尺会降低视觉体验，确定继续？"))return t("scale").value=z().toString();if(tt=s){if(!(et=await async function(){let e,s,i,n,r=t("file-output").files;if(!r.length)return E('<span class="text-danger">未选择决策文件</span>');if((s=(e=await r[0].text()).split("\n")).length>2||2===s.length&&s[1])return E('<span class="text-danger">决策文件过长</span>');if((e=s[0].trimEnd()).length!==v)return E(`<span class="text-danger">决策文件第 1 行：期望长度为 ${v} 的字符串，但读取到长度为 ${e.length} 的字符串</span>`);for(i=0;i<v;++i)if(!"WXADQZECS".includes(e[i]))return E(`<span class="text-danger">决策文件第 1 行：第 ${i+1} 个字符 <samp>"${n=32<=(n=e.charCodeAt(i))&&n<=126?e[i]:0<=n&&n<=255?`<strong>\\x${n.toString(16).padStart(2,"0")}</strong>`:`<strong>\\u${n.toString(16).padStart(4,"0")}</strong>`}"</samp> 不合法</span>`);return e}()))return}else et="S".repeat(v);et=et.split(""),e.setAttribute("width",D+"px"),e.setAttribute("height",G+"px"),E('<span class="text-success">配置成功，准备进入游戏 ...</span>'),F("准备中 ..."),window.scrollTo({top:t("stage-title").parentNode.offsetTop-10,behavior:"smooth"}),t("file-input").disabled=!0,t("file-output").disabled=!0,t("scale").disabled=!0,t("tscale").disabled=!0,t("queue-op").disabled=!0,t("sx-swap").disabled=!0,t("download-op").disabled=!0,t("start-manual").disabled=!0,t("start-auto").disabled=!0,t("stage-text-elem").setAttribute("x",D/2),t("stage-text-elem").setAttribute("y",G/2),t("stage-text-elem").style.fontSize="36px",t("stage-text-elem").textContent="Preparing ...",t("stage-text-elem").style.visibility="",t("player-body-circle").setAttribute("cx",m*X),t("player-body-circle").setAttribute("cy",b*X),t("player-body-circle").setAttribute("r",Math.max(y*X,2)),t("player-graze-circle").setAttribute("cx",m*X),t("player-graze-circle").setAttribute("cy",b*X),t("player-graze-circle").setAttribute("r",Math.max(x*X,2)),t("cur-coordinate-x").innerHTML=m.toFixed(2),t("cur-coordinate-y").innerHTML=b.toFixed(2),ot=t("sx-swap").checked?t=>83===t||88===t?11^t:t:t=>t,B={W:[0,-g],X:[0,g],A:[-g,0],D:[g,0],Q:[-i,-i],Z:[-i,i],E:[i,-i],C:[i,i]},st=t("queue-op").checked?()=>at.query():()=>rt.query(),L=[...k],setTimeout(()=>{const e=e=>{t("stage-text-elem").style.fontSize="100px",t("stage-text-elem").textContent=e},s=(t,e,s)=>{t.hasOwnProperty(e)||(t[e]=[]),t[e].push(s)};t("stage-bullet-definitions").innerHTML="",a.innerHTML="",Q=document.createDocumentFragment(),W=new Set,Z={},J={},A=[];for(let t=0;t<w;++t)A[t]=new ct(t,...S[t]),s(Z,A[t].ta,t),s(J,A[t].tb+1,t);t("stage-bullet-definitions").appendChild(Q),setTimeout(()=>e("3"),50),setTimeout(()=>e("2"),1050),setTimeout(()=>e("1"),2050),setTimeout(ft,3050)},50)}function ft(){t("stage-text-elem").style.visibility="hidden",E('<span class="text-success">游戏进行中 ...</span>'),rt.reset(),at.reset(),dt.reset(),V=h(),it=BigInt(0),M=0,U=m,j=b,nt=-1,K=new Array(w).fill(!1),d(ht)}function mt(){if(J.hasOwnProperty(v+1))for(let t of J[v+1])a.removeChild(A[t].circle);for(let t=0;t<w;++t)if(A[t].circle.style.fill=`url(#GR${A[t].g})`,A[t].circle.classList.remove("bullet-close"),A[t].hasOwnProperty("movement")){let e=A[t].movement,s=e.cloneNode();e.setAttribute("fill","remove"),e.endElement(),A[t].circle.replaceChild(s,e),A[t].movement=s}E('<span class="text-info">游戏已结束，您可以点击上方的蓝色按钮导出决策文件</span>'),F("已结束"),t("player-body-circle").setAttribute("cx",1e18),t("player-body-circle").setAttribute("cy",1e18),t("player-graze-circle").setAttribute("cx",1e18),t("player-graze-circle").setAttribute("cy",1e18),t("stage-text-elem").style.fontSize="24px",t("stage-text-elem").textContent=`最终成绩：${it}`,t("stage-text-elem").style.visibility="",t("file-input").disabled=!1,t("file-output").disabled=!1,t("scale").disabled=!1,t("tscale").disabled=!1,t("queue-op").disabled=!1,t("sx-swap").disabled=!1,t("download-op").disabled=!1,t("start-manual").disabled=!1,t("start-auto").disabled=!1}t("start-manual").addEventListener("click",(function(){pt(!1)})),t("start-auto").addEventListener("click",(function(){pt(!0)})),t("download-op").addEventListener("click",(function(){if(Array.isArray(et)&&et.length===v){let e,s=t("file-input").value;e=(s=s.substr(Math.max(s.lastIndexOf("/"),s.lastIndexOf("\\"))+1)).lastIndexOf("."),s=~e?s.substr(0,e):s,(e=document.createElement("a")).href=URL.createObjectURL(new Blob([et.join("")+"\n"],{type:"text/plain"})),e.download=`${s}.out`,e.click(),URL.revokeObjectURL(e.href)}else alert("尚未找到决策，请先开始游戏")}))};