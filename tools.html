<!DOCTYPE html>
<html lang="zh-cn">
	<head>
		<!-- version 6.0 -->
		<meta charset="utf-8">
		<link type="text/css" rel="stylesheet" href="additional_files/css/fonts.css">
		<link type="text/css" rel="stylesheet" href="additional_files/css/sh_typical.min.css">
		<link type="text/css" rel="stylesheet" href="additional_files/css/pgmain.min.css">
		<link type="text/css" rel="stylesheet" href="additional_files/css/rating.min.css">
		<title>OI 中转站 - 小工具</title>
		<script src="additional_files/js/jquery.min.js"></script>
		<script src="additional_files/js/basic.min.js"></script>
		<script src="additional_files/js/file.min.js"></script>
		<script src="additional_files/js/sort.min.js"></script>
		<script>
			jQuery(document).ready($ => {
				initPage();

				if (window.BigInt) { // bigint is available
					let B = window.BigInt;

					function PowerMod(a, n, m) {
						let c = B(1);
						for (a %= m; n; n >>= B(1), a = a * a % m)
							if (n & B(1)) c = c * a % m;
						return c % m;
					}

					function tr(s, name) {
						if (s === '') return name + ' is not a valid integer';
						try {
							return B(s);
						} catch (e) {
							return name + ' is not a valid integer';
						}
					}

					window.pow = function(a, n, m) {
						if (a = tr(a, 'a'), typeof a !== 'bigint') return a;
						if (n = tr(n, 'n'), typeof n !== 'bigint') return n;
						if (n < 0) return 'n is negative';
						if (m = tr(m, 'm'), typeof m !== 'bigint') return m;
						if (m <= 0) return 'm is not positive';
						return PowerMod(a % m + m, n, m);
					}

					function Miller_Rabin(n) {
						let c = B(0), j, s = n - B(1), u, v;
						for (; !(s & B(1)); ++c, s >>= B(1));
						for (let p of [2, 3, 5, 7, 11, 13, 82, 373].map(B)) {
							if (!(n % p)) return false;
							u = PowerMod(p, s, n);
							for (j = B(0); j < c; ++j, u = v)
								if (v = u * u % n, u != 1 && u !== n - B(1) && v == 1) return false;
							if (u != 1) return false;
						}
						return true;
					}

					window.isp = function(n) {
						if (n = tr(n, 'n'), typeof n !== 'bigint') return n;
						if (n < 2 || n >= B(1) << B(64)) return "n is not in range [2, 2^64)";
						return n < 32 || n == 41 || n == 373 ? !(B(1601558355) >> n & B(1)) : Miller_Rabin(n);
					}

					$('#status-power-mod').html('您的浏览器<strong style="color: #09f">滋磁</strong> <code>BigInt</code>，可以完成任意精度的计算。');
					$('#status-primality-test').html('您的浏览器<strong style="color: #09f">滋磁</strong> <code>BigInt</code>，可以完成 2<sup>64</sup> 内素数的判定。');
				} else {
					function MulMod(a, b, m) {
						let ah = a >> 16, al = a & 0xffff, bh = b >> 16, bl = b & 0xffff;
						let H = ah * bh % m, M = (ah * bl + al * bh) % m, L = al * bl % m;
						return ((H * 0x10000 % m + M) * 0x10000 % m + L) % m;
					}
	
					function PowerMod(a, n, m) {
						let c = 1;
						for (a %= m; n; n >>= 1, a = MulMod(a, a, m))
							if (n & 1) c = MulMod(c, a, m);
						return c % m;
					}

					window.pow = function(a, n, m) {
						if (!$.isNumeric(a)) return 'a is not a valid integer';
						if (a = parseFloat(a), Math.floor(a) !== a) return 'a is not a valid integer';
						if (a < 0 || a > 0x7fffffff) return 'a is not in range [0, 2^31)';
						if (!$.isNumeric(n)) return 'n is not a valid integer';
						if (n = parseFloat(n), Math.floor(n) !== n) return 'n is not a valid integer';
						if (n < 0 || n > 0x7fffffff) return 'n is not in range [0, 2^31)';
						if (!$.isNumeric(m)) return 'm is not a valid integer';
						if (m = parseFloat(m), Math.floor(m) !== m) return 'm is not a valid integer';
						if (m < 1 || m > 0x7fffffff) return 'm is not in range [1, 2^31)';
						return PowerMod(a, n, m);
					}

					function Miller_Rabin(n) {
						let c = 0, j, s = n - 1, u, v;
						for (; !(s & 1); ++c, s >>= 1);
						for (let p of [2, 7, 61]) {
							if (!(n % p)) return false;
							u = PowerMod(p, s, n);
							for (j = 0; j < c; ++j, u = v)
								if (v = MulMod(u, u, n), u !== 1 && u !== n - 1 && v === 1) return false;
							if (u !== 1) return false;
						}
						return true;
					}

					window.isp = function(n) {
						if (!$.isNumeric(n)) return 'n is not a valid integer';
						if (n = parseFloat(n), Math.floor(n) !== n) return 'n is not a valid integer';
						if (n < 2 || n > 0x7fffffff) return 'n is not in range [2, 2^31)';
						return n < 32 || n === 61 ? !(1601558355 >> n & 1) : Miller_Rabin(n);
					}

					$('#status-power-mod').html('您的浏览器<strong style="color: #630">不滋磁</strong> <code>BigInt</code>，只能完成 2<sup>31</sup> 内整数的计算。');
					$('#status-primality-test').html('您的浏览器<strong style="color: #630">不滋磁</strong> <code>BigInt</code>，只能完成 2<sup>31</sup> 内素数的判定。');
				}

				$('#calc-power-mod').click(function () {
					let a = $('#div-power-mod input[name="a"]').val();
					let n = $('#div-power-mod input[name="n"]').val();
					let m = $('#div-power-mod input[name="m"]').val();
					$('#div-power-mod input[name="result"]').val(pow(a, n, m).toString());
				});

				$('#calc-primality-test').click(function () {
					let n = $('#div-primality-test input[name="n"]').val();
					$('#div-primality-test input[name="result"]').val(isp(n).toString());
				});

				$('.sortlink').click(function () {
					sortTable('R' + getSortChar2($(this.parentNode).index()));
					$('#rankTable>tbody').empty().append(Rows);
				});

				$.ajax('https://codeforces.com/api/user.info?handles=' + persons.join(';'), {
					type: 'GET',
					crossDomain: true,
					dataType: 'jsonp',
					jsonp: 'jsonp',
					success: parseRanklist,
					error: () =>
						$.ajax('https://codeforc.es/api/user.info?handles=' + persons.join(';'), {
							type: 'GET',
							crossDomain: true,
							dataType: 'jsonp',
							jsonp: 'jsonp',
							success: parseRanklist,
							error: () => $('#rankTable>tbody>tr>td').html('Network failed. Please check your network or refresh this page.')
						})
				});

				if (getStorage('marquee') === 'on') {
					$('#status-marquee').html('on').css('color', '#090');
					$('#toggle-marquee').html('关闭');
				}

				if (getStorage('speed') === 'on') {
					$('#status-speed').html('on').css('color', '#090');
					$('#toggle-speed').html('关闭');
				}

				$('#ctrl-marquee').click(function () {
					if ($('#intro').is(':hidden')) {
						$('#status-marquee').html('off').css('color', '#09f');
						$('#toggle-marquee').html('开启');
					} else {
						$('#status-marquee').html('on').css('color', '#090');
						$('#toggle-marquee').html('关闭');
					}
				});

				$('#toggle-marquee').click(function () {
					$('#ctrl-marquee').click();
				});

				$('#toggle-speed').click(function () {
					if (getStorage('speed') === 'on') {
						$('#status-speed').html('off').css('color', '#09f');
						$('#toggle-speed').html('开启');
						setStorage('speed', 'off');
					} else {
						$('#status-speed').html('on').css('color', '#090');
						$('#toggle-speed').html('关闭');
						setStorage('speed', 'on');
					}
				});
			});
		</script>
	</head>
	<body>
		<div class="title">
			<div class="opacity-3 flex" style="height: 160px">
				<div style="width: 100%">
					<h2 class="cen">OI 中转站 - 小工具</h2>
					<p class="cen" id="dispTime">当前时间: 2020-7-31 12:00:00</p>
					<p class="ri" id="motto" style="opacity: 0; margin-top: -20px">slowly step into the fast-paced life.</p>
				</div>
			</div>
		</div>
		<div class="dmarquee" style="height: 25px">
			<div class="button-transparent" id="ctrl-marquee" style="float: left">
				<p class="hint">开启字幕</p>
			</div>
			<div class="button-transparent" id="ctrl-export" style="float: right">
				<p class="hint">导出表格</p>
			</div>
			<div style="overflow: hidden">
				<marquee id="intro" scrollamount="1000" style="color: #999; display: none">bestFy is the cutest !</marquee>
			</div>
		</div>
		<div class="main">
			<div class="opacity-4 padding" style="min-height: 1344px">
				<div class="cen big-button">
					<button onclick="location.href='index.html'">做题记录</button><button>小工具</button><button onclick="location.href='templates.html'">模板</button><button onclick="location.href='memos.html'">便笺</button>
				</div>
				<fieldset>
					<legend>小工具</legend>
					<div class="border-tool padding-1" id="div-power-mod">
						<p>快速幂 (幂模运算，计算 <em>a<sup>n</sup></em> mod <em>m</em>):</p>
						<p><label><em>a</em>: </label><input name="a" placeholder="a" class="cen text-input" /> <label><em>n</em>: </label><input name="n" placeholder="n" class="cen text-input" /> <label><em>m</em>: </label><input name="m" placeholder="m" class="cen text-input" /> <button class="big-button" id="calc-power-mod">计算</button></p>
						<p>结果: <input name="result" placeholder="result" readonly="readonly" class="cen text-input" style="width: 250px" /></p>
						<hr />
						<div style="font-size: smaller">
							<p id="status-power-mod" style="color: #090"></p>
							<p>注：可以在 JS 控制台中使用 <code>pow</code> 函数来进行快速幂。</p>
						</div>
					</div>
					<div class="border-tool padding-1" id="div-primality-test">
						<p>质数判定</p>
						<p><label><em>n</em>: </label><input name="n" placeholder="n" class="cen text-input" style="width: 200px" /> <button class="big-button" id="calc-primality-test">判定</button></p>
						<p>结果：<input name="result" placeholder="result" readonly="readonly" class="cen text-input" style="width: 250px" /></p>
						<hr />
						<div style="font-size: smaller">
							<p id="status-primality-test" style="color: #090"></p>
							<p>注：可以在 JS 控制台中使用 <code>isp</code> 函数来进行质数判定。</p>
						</div>
					</div>
					<div class="border-tool padding-1" id="div-ranklist">
						<p>Rating 排行榜 (Codeforces, Links)</p>
						<table class="cen main-table" id="rankTable" style="width: 100%">
							<thead>
								<tr>
									<th style="width: 14%"><span class="sortlink">Username</span></th>
									<th style="width: 10%"><span class="sortlink">First Name</span></th>
									<th style="width: 10%"><span class="sortlink">Last Name</span></th>
									<th style="width: 9%"><span class="sortlink">Rating</span></th>
									<th style="width: 9%"><span class="sortlink">Max Rating</span></th>
									<th style="width: 18%"><span class="sortlink">Last Online Time</span></th>
									<th style="width: 30%"><span class="sortlink">Personal Blog Link</span></th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td colspan="7" style="line-height: 2em">Waiting ...</td>
								</tr>
							</tbody>
						</table>
						<p>ps: 要申请者请提供在 <strong>Codeforces</strong> 上的 ID (即 handle) 以及个人博客链接 (可选)，联系<a href="mailto:yhx0706@163.com">此处</a>。<span style="color: transparent">(Q<sup>2</sup> = 0x1af97fbd)</span></p>
						<p>或者也可以来 <a href="https://github.com/yhx-12243/OI-transit" target="_blank">GitHub</a> 提交 Issue/Pull Request。</p>
					</div>
					<div class="border-tool padding-1" id="div-settings">
						<p>更多设置 <span style="color: transparent">(将鼠标移到标题栏下方空白处的两端有惊喜哦！)</span></p>
						<p><label>当前字幕状态：<strong id="status-marquee" style="color: #09f">off</strong></label> <button class="big-button" id="toggle-marquee">开启</button></p>
						<p><label>极速浏览模式 (敬请期待)：<strong id="status-speed" style="color: #09f">off</strong></label> <button class="big-button" id="toggle-speed">开启</button></p>
					</div>
				</fieldset>
			</div>
		</div>
	</body>
</html>
